<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>D.A.R.K. Wiki - Katalog Anomalii</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="wiki-container">
        <nav class="wiki-nav terminal-style">
            <div class="terminal-window">
                <div class="terminal-header text-center glitch-text">
                    <span>>> D.A.R.K. <<</span>
                </div>
                <div class="terminal-header corrupted-text">
                    <span>[SYSTEM] Terminal - Nawigacja</span>
                </div>
                <div class="terminal-body">
                    <div class="nav-buttons">
                        <a href="/wiki" class="nav-panel">
                            <div class="terminal-separator">===================</div>
                            <div class="panel-text">Strona G≈Ç√≥wna</div>
                            <div class="terminal-separator">===================</div>
                        </a>
                        <a href="/wiki/eidsystem" class="nav-panel">
                            <div class="terminal-separator">===================</div>
                            <div class="panel-text">E.I.D. System</div>
                            <div class="terminal-separator">===================</div>
                        </a>
                        <a href="/wiki/anomalies" class="nav-panel">
                            <div class="terminal-separator">===================</div>
                            <div class="panel-text">Katalog Anomalii</div>
                            <div class="terminal-separator">===================</div>
                        </a>
                        <a href="/wiki/personnel" class="nav-panel">
                            <div class="terminal-separator">===================</div>
                            <div class="panel-text">Personel</div>
                            <div class="terminal-separator">===================</div>
                        </a>
                        <a href="/wiki/reports" class="nav-panel">
                            <div class="terminal-separator">===================</div>
                            <div class="panel-text">Raporty</div>
                            <div class="terminal-separator">===================</div>
                        </a>
                    </div>
                </div>
            </div>
        </nav>

        <main class="wiki-content terminal-style">
            <div class="terminal-window">
                <div class="terminal-header">
                    <span id="terminalPath">> D.A.R.K. Terminal - Katalog Anomalii</span>
                </div>
                <div class="terminal-body">
                    <div id="eidEntries" class="terminal-entries">
                        <div class="terminal-line">> D.A.R.K. Terminal - Katalog Anomalii</div>
                        <div class="terminal-line">> Inicjalizacja systemu...</div>
                        <div class="terminal-line">> ≈Åadowanie bazy danych E.I.D....</div>
                        <div class="terminal-line">> Dostƒôp przyznany. Wy≈õwietlam listƒô:</div>
                        <div class="terminal-line terminal-button" onclick="showAddEIDModal()">[+ DODAJ NOWƒÑ ANOMALIƒò]</div>
                    </div>
                </div>

                <!-- Modal do dodawania nowej anomalii -->
                <div id="addEIDModal" class="modal" style="display: none;">
                    <div class="modal-content terminal-window">
                        <div class="terminal-header">
                            <span>> Dodawanie Nowej Anomalii</span>
                        </div>
                        <div class="terminal-body">
                            <div class="terminal-line">Proponowane ID: <span id="suggestedId">4000</span></div>
                            <input type="text" id="newEidId" class="terminal-input" onchange="validateEidId(this.value)">
                            <div id="idValidation" class="terminal-line"></div>
                            <input type="text" id="newEidName" placeholder="Nazwa" class="terminal-input">
                            <textarea id="newEidDescription" placeholder="Opis" class="terminal-input" spellcheck="true"></textarea>
                            <select id="newEidDisruptionLevel" class="terminal-input">
                                <option value="">Wybierz Poziom Zak≈Ç√≥ce≈Ñ</option>
                                <option value="Null">‚ö™ Null - Brak zauwa≈ºalnych zak≈Ç√≥ce≈Ñ</option>
                                <option value="Verdant">üü¢ Verdant - Minimalne zak≈Ç√≥cenia</option>
                                <option value="Azure">üîµ Azure - Lokalnie ograniczone zak≈Ç√≥cenia</option>
                                <option value="Amber">üü° Amber - Zak≈Ç√≥cenia na poziomie miejskim</option>
                                <option value="Tangerine">üü† Tangerine - Zak≈Ç√≥cenia na skalƒô krajowƒÖ</option>
                                <option value="Crimson">üî¥ Crimson - Powa≈ºne zak≈Ç√≥cenia</option>
                                <option value="Obsidian">‚ö´ Obsidian - Ekstremalne zak≈Ç√≥cenia</option>
                                <option value="Navy">üîµ Navy - Globalne zak≈Ç√≥cenia</option>
                                <option value="Violet">üü£ Violet - Zak≈Ç√≥cenia o nieznanym charakterze</option>
                            </select>
                            <select id="newEidRiskLevel" class="terminal-input">
                                <option value="">Wybierz Poziom Ryzyka</option>
                                <option value="Null">‚ö™ Null - Brak zagro≈ºenia</option>
                                <option value="Caution">üü¢ Caution - Niskie zagro≈ºenie</option>
                                <option value="Alert">üîµ Alert - Umiarkowane zagro≈ºenie</option>
                                <option value="Warning">üü° Warning - ZnaczƒÖce zagro≈ºenie</option>
                                <option value="Danger">üü† Danger - Wysokie zagro≈ºenie</option>
                                <option value="Critical">üî¥ Critical - Ekstremalne zagro≈ºenie</option>
                                <option value="Obsidian">‚ö´ Obsidian - Katastrofalne zagro≈ºenie</option>
                                <option value="Abyss">üü£ Abyss - Nieznane zagro≈ºenie</option>
                            </select>
                            <textarea id="newEidProcedures" placeholder="Procedury" class="terminal-input"></textarea>
                            <textarea id="newEidHistory" placeholder="Historia" class="terminal-input"></textarea>
                            <textarea id="newEidNotes" placeholder="Notatki" class="terminal-input"></textarea>
                            <div class="terminal-controls">
                                <button onclick="saveNewEID()" class="terminal-button">[ZAPISZ]</button>
                                <button onclick="closeAddEIDModal()" class="terminal-button">[ANULUJ]</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        async function generateNextAvailableId() {
            const response = await fetch('/database/eid_entries');
            const entries = await response.json();
            const existingIds = entries.map(entry => parseInt(entry.id));
            let proposedId = 2; // Start from 002

            while (existingIds.includes(proposedId)) {
                proposedId++;
            }

            // Format the ID to have at least 3 digits
            const formattedId = proposedId.toString().padStart(3, '0');
            document.getElementById('suggestedId').textContent = formattedId;
            document.getElementById('newEidId').value = formattedId;
            return formattedId;
        }

        async function validateEidId(id) {
            const response = await fetch('/database/eid_entries');
            const entries = await response.json();
            const existingIds = entries.map(entry => entry.id);
            const validationDiv = document.getElementById('idValidation');

            if (existingIds.includes(id)) {
                validationDiv.innerHTML = '‚ùå ID jest ju≈º zajƒôte';
                validationDiv.style.color = '#ff0000';
                await generateNextAvailableId(); // Generate new suggestion if ID is taken
                return false;
            } else if (!/^\d{3,}$/.test(id)) {
                validationDiv.innerHTML = '‚ùå ID musi sk≈Çadaƒá siƒô z minimum 3 cyfr';
                validationDiv.style.color = '#ff0000';
                return false;
            } else {
                validationDiv.innerHTML = '‚úÖ ID jest dostƒôpne';
                validationDiv.style.color = '#00ff00';
                return true;
            }
        }

        // Call generateNextAvailableId when modal is opened
        function showAddEIDModal() {
            document.getElementById('addEIDModal').style.display = 'block';
            generateNextAvailableId();
        }

        async function loadEIDEntries() {
            const response = await fetch('/database/eid_entries');
            const entries = await response.json();
            const container = document.getElementById('eidEntries');

            container.innerHTML = `
                <div class="terminal-line">> D.A.R.K. Terminal - Katalog Anomalii</div>
                <div class="terminal-line">> Inicjalizacja systemu...</div>
                <div class="terminal-line">> ≈Åadowanie bazy danych E.I.D....</div>
                <div class="terminal-line">> Dostƒôp przyznany. Wy≈õwietlam listƒô:</div>
                <div class="terminal-line terminal-button" onclick="showAddEIDModal()">[+ DODAJ NOWƒÑ ANOMALIƒò]</div>
            `;

            entries.forEach(entry => {
                const separator = '==============================================';
                const entryDiv = document.createElement('div');
                entryDiv.className = 'eid-entry-link';
                entryDiv.innerHTML = `
                    <div class="separator">${separator}</div>
                    <div class="entry-title">E.I.D.-${entry.id}: ${entry.name}</div>
                    <div class="separator">${separator}</div>
                `;

                entryDiv.addEventListener('click', () => showEIDDetails(entry));
                container.appendChild(entryDiv);
            });
        }

        function showEIDDetails(entry) {
            document.getElementById('terminalPath').textContent = `> D.A.R.K. Terminal - Katalog Anomalii/E.I.D.-${entry.id}`;

            const container = document.getElementById('eidEntries');
            container.innerHTML = `
                <div class="terminal-line">> Wy≈õwietlam szczeg√≥≈Çy E.I.D.-${entry.id}</div>
                <div class="terminal-line">==============================================</div>
                <div class="terminal-line">Nazwa: ${entry.name}</div>
                <div class="terminal-line">Poziom Zak≈Ç√≥ce≈Ñ: <span class="level-${entry.disruption_level.toLowerCase()}">${entry.disruption_level}</span></div>
                <div class="terminal-line">Poziom Ryzyka: <span class="risk-${entry.risk_level.toLowerCase()}">${entry.risk_level}</span></div>
                <div class="terminal-line">==============================================</div>
                <div class="terminal-line">Opis:</div>
                <div class="terminal-line">${entry.description}</div>
                <div class="terminal-line">==============================================</div>
                <div class="terminal-line">Procedury:</div>
                <div class="terminal-line">${entry.procedures}</div>
                <div class="terminal-line">==============================================</div>
                <div class="terminal-line">Historia:</div>
                <div class="terminal-line">${entry.history}</div>
                <div class="terminal-line">==============================================</div>
                <div class="terminal-line">Notatki:</div>
                <div class="terminal-line">${entry.notes}</div>
                <div class="terminal-line">==============================================</div>
                <div class="back-button terminal-line">> [POWR√ìT DO LISTY]</div>
            `;

            document.querySelector('.back-button').addEventListener('click', () => {
                document.getElementById('terminalPath').textContent = '> D.A.R.K. Terminal - Katalog Anomalii';
                loadEIDEntries();
            });
        }

        function showAddEIDModal() {
            document.getElementById('addEIDModal').style.display = 'block';
        }

        function closeAddEIDModal() {
            document.getElementById('addEIDModal').style.display = 'none';
        }

        async function saveNewEID() {
            const newEID = {
                id: document.getElementById('newEidId').value,
                name: document.getElementById('newEidName').value,
                description: document.getElementById('newEidDescription').value,
                disruption_level: document.getElementById('newEidDisruptionLevel').value,
                risk_level: document.getElementById('newEidRiskLevel').value,
                procedures: document.getElementById('newEidProcedures').value,
                history: document.getElementById('newEidHistory').value,
                notes: document.getElementById('newEidNotes').value
            };

            try {
                const response = await fetch('/save_eid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(newEID)
                });

                if (response.ok) {
                    alert('E.I.D. zosta≈Ço pomy≈õlnie zapisane!');
                    closeAddEIDModal();
                    loadEIDEntries();
                } else {
                    alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania E.I.D.');
                }
            } catch (error) {
                console.error('B≈ÇƒÖd podczas zapisywania:', error);
                alert('WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisywania E.I.D.');
            }
        }

        loadEIDEntries();
    </script>
</body>
</html>